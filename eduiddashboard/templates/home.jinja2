{% extends "templates/base.jinja2" %}

{% block nav_class_home %}active{% endblock %}

{% block headjs %}
<script href="{{'deform:static/scripts/deform.js'|static_url }}"></script>
<script href="{{'deform_bootstrap:static/deform_bootstrap.js'|static_url }}"></script>
{% endblock %}


{% macro email_status_macro(verified) -%}
  {% if verified %}
    <button title='{{ _('Verified') }}'
       class='btn btn-link btn-icon'
       data-toggle='tooltip'>
       <i class='icon-ok'></i>
    </button>
  {% else %}
    <button title='{{ _('Email not verified') }}'
       class='btn btn-link btn-icon'
       data-toggle='tooltip'>
      <i class='icon-remove'></i>
    </button>
  {% endif %}
{%- endmacro %}


{% macro add_email_button() -%}
  <button class='add-email btn btn-link btn-icon'
          title='{{ _('Add a new email') }}'
          data-toggle='tooltip'>
    <i class='icon-plus'></i>
  </button>
{%- endmacro %}


{% macro remove_email_button(show=True) -%}
  <button class='btn btn-link btn-icon {% if not show %}hide{% endif %}'
          title='{{ _('Remove this email') }}'
          type='submit'
          data-toggle='tooltip'>
    <i class='icon-trash'></i>
  </button>
{%- endmacro %}


{% macro validate_email_button() -%}
  <button class='btn btn-link btn-icon'
          title='{{ _('Validate this email') }}'
          type='submit'
          data-toggle='tooltip'>
    <i class='icon-refresh'></i>
  </button>
{%- endmacro %}


{% macro email_actions(email, show_remove=True) -%}
  <form method="POST" class='form-inline inline' action='{{ 'email-actions'|route_url}}'>
    <input type='hidden' name='email' value="{{ email['email'] }}"/>
    {% if primary_email == email['email'] %}
      {{ remove_email_button(show=False) }}
    {% else %}
      {{ remove_email_button(show=True) }}
    {% endif %}
    {% if not email['verified'] %}
      {{ validate_email_button() }}
    {% endif %}
  </form>
{%- endmacro %}


{% macro email_form_macro(emails, primary_email) -%}
  <div class='emails-form'>
    {% for email in emails %}
    <div class='row'>
      <div class='span2'>
        <input type='radio' name='primary-email' value="{{ email['email'] }}" 
         {% if primary_email == email['email'] %}checked{% endif %}/>
        {{ email_actions(email) }}
      </div>
      <div class='span3'>
        <span class='email'>{{ email['email'] }}</span>
      </div>
      <div class='span1'>
        {{ email_status_macro(email['verified']) }}
      </div>
    </div>
    {% endfor %}
  </div>
  {{ add_email_button() }}
{%- endmacro %}


{% block contents %}
  <h2>{{ _("eduID dashboard.") }}</h2>

  <div class='loa-big'>
    <div>{{ _('Level %(level)s')|format(level=request.session.get('loa', 5)) }}</div>
  </div>

  <h3>{{ _("Summary") }}</h3>

  <div class='clearfix'></div>

  <div class='row'>
    <div class='span6'>
      <h4>{{ _("Level of assurance") }}</h4>

        <ul class='circles-widget-labels'>
          <li><a href='#' title="{{ _('Level 5') }}" data-toggle='popover'
                data-content='{{ _("This is the lower level you can reach,"
                                   "With this loa you can edit some attributes"
                                   "of your profile") }}'>
              {{ _('Level 5') }}</a></li>
          <li><a href='#' title="{{ _('Level 4') }}" data-toggle='popover'
                data-content='{{ _("With this loa you can edit some attributes"
                                   "of your profile") }}'>
              {{ _('Level 4') }}</a></li>
          <li><a href='#' title="{{ _('Level 3') }}" data-toggle='popover'
                data-content='{{ _("With this loa you can edit some attributes"
                                   "of your profile") }}'>
              {{ _('Level 3') }}</a></li>
          <li><a href='#' title="{{ _('Level 2') }}" data-toggle='popover'
                data-content='{{ _("With this loa you can edit some attributes"
                                   "of your profile") }}'>
              {{ _('Level 2') }}</a></li>

        </ul>
        <div class='circles-widget  level-{{ request.session.get('loa', 5) }}' >
          <img src="{{ 'eduiddashboard:static/img/circle-bar.png'|static_url }}" />
          <div class='bar'></div>
        </div>

        <div class='popover-container'>
        </div>

        <div class='level-assurance-description'>
          {% trans %}
          <p>You are in 4 level. If you want to increase this level to ge
          more permissions you need to:</p>
          <ul>
            <li>Validate your postal address</li>
            <li>Validate your NIN number</li>
          </ul>
          {% endtrans %}
        </div>
    </div>

    <div class='span6'>
      <h4>{{ _("Profile filled") }}: {{ profile_filled }}%</h4>
      <div class="progress progress-striped">
        <div class="bar" style="width: {{ profile_filled }}%;"></div>
      </div>
    </div>
  </div>


  <div class='clear'></div>

  <div class='profile-combo tabbable tabs-left'>
    <ul class='nav nav-tabs'>
      <li class='active'>
        <a href='#personal' data-toggle='tab'>{{ _("Personal Info") }}</a>
      </li>
      <li>
        <a href='#email' data-toggle='tab'>{{ _("Email") }}</a>
      </li>
      <li>
        <a href='#passwords' data-toggle='tab'>{{ _("Passwords") }}</a>
      </li>
    </ul>

    <div class='tab-content'>
      <div class='tab-pane active' id='personal'>
        <div class='profile-form'>
          <div class='intro'>
          {% trans %}This is your personal info{% endtrans %}
          </div>
          {{ person_form.render(person)|safe }}
        </div>
      </div>

      <div class='tab-pane email-form' id='email'>
        {% trans %}<p>These list contain all your emails registered in the
        platform. You can change your primary email selected by radio buttons.
        </p><p>Remember, if you select a not verified email as your primary
        email, your level of assurance must be decreased.</p>
        {% endtrans %}

        {{ email_form_macro(emails, primary_email) }}
      </div>

      <div class='tab-pane' id='passwords'>
        <div>
          This is the change password form
        </div>
      </div>
    </div>
  </div>


{% endblock %}

{% block extrajs %}
<script>

var email_forms = function () {
  $('button.add-email').click(function (e) {
    $(this).before($('#add-email-form').html());
  });
};

var loa_popovers = function () {
  $('.circles-widget-labels a').popover({
    placement: 'bottom',
    trigger: 'hover'
  });
};

$(document).ready(function () {
    $("a[data-toggle=tooltip]").tooltip();
    $("button[data-toggle=tooltip]").tooltip();
    email_forms();
    loa_popovers();
});

</script>

<script type='text/template' id='add-email-form'>
  <form action="{{ 'email-actions'|route_url}}" method="POST">
    <div class='row add-email-form'>
      <div class='span2'>
          <input type='radio' name='primary-email' disabled>
      </div>
      <div class='input-append span5'>
        <input name='new-email' type='email' placeholder='Add a new email'/>
        <button class="btn btn-success" type="submit" value='new-email'>{{ _('Submit') }}</button>
      </div>
    </div>
  </form>
</script>

{% endblock %}
